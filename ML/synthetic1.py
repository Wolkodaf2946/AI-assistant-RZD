import json
import time
from random import choice, shuffle
from tqdm import tqdm
import os
import requests
from huggingface_hub import InferenceClient


situations = [
    "Поломка локомотива на перегоне",
    "Сход подвижного состава с рельсов",
    "Обрыв контактной сети",
    "Сигнализация неисправна или подает ложные сигналы",
    "Выход из строя стрелочного перевода",
    "Заклинивание колесной пары",
    "Нехватка локомотивных бригад",
    "Задержка прибытия поезда на станцию",
    "Неисправность системы автоматической блокировки",
    "Пожар в вагоне или локомотиве",
    "Нарушение целостности железнодорожного полотна",
    "Повреждение железнодорожного моста или туннеля",
    "Падение дерева или постороннего предмета на пути",
    "Затопление пути из-за погодных условий",
    "Обнаружение посторонних лиц на путях",
    "Неисправность тормозной системы поезда",
    "Отклонение состава от графика движения",
    "Остановка поезда на перегоне без возможности продолжения движения",
    "Аварийное торможение без видимой причины",
    "Выброс груза из вагона на пути",
    "Попадание животных на пути",
    "Теракт или угроза его совершения на железной дороге",
    "Диспетчерская ошибка при координации движения",
    "Нарушение правил безопасности персоналом",
    "Отказ связи между диспетчером и машинистом",
    "Неисправность светофоров или нарушение сигнализации",
    "Погодные условия, ухудшающие видимость (туман, сильный дождь, снегопад)",
    "Задержка прибытия ремонтных бригад на место неисправности",
    "Отсутствие свободных путей для приема поезда на станцию",
    "Перегрузка железнодорожного узла из-за увеличенного трафика",
    "Разрыв сцепки вагонов в пути следования",
    "Проблемы с энергоснабжением на электрических линиях",
    "ДТП на железнодорожном переезде",
    "Самовольное пересечение путей пешеходами",
    "Ошибка в расписании движения поездов",
    "Сбой в компьютерных системах управления движением",
    "Возникновение паники среди пассажиров из-за технических неполадок",
    "Неисправность системы автоматического торможения",
    "Закрытие участка пути по техническим причинам",
    "Опасный груз на поезде, создающий угрозу утечки",
    "Утрата связи с поездом на длительное время",
    "Нарушение работы сортировочных станций",
    "Несанкционированное вмешательство в работу железной дороги",
    "Технические работы, затрудняющие движение поездов",
    "Отключение системы навигации и позиционирования поездов",
    "Протечки топлива или масла в локомотиве",
    "Сбой системы контроля подвижного состава",
    "Опоздание ремонтного состава к месту происшествия",
    "Выход из строя системы кондиционирования в пассажирском поезде",
    "Угроза схода снежной лавины на пути",
    "Залет дрона или птицы в контактную сеть",
    "Диспетчерская ошибка при организации пропуска встречных поездов"
]

system_prompt = '''system: Ты ассистент диспетчера. Тебе надо не говорить общие вещи, а давать чёткие указания что делать диспетчеру по ситуации. Очень важная часть - восстановление графика движения пассажирских поездов.
Тебе не надо писать ситуацию, напиши только алгоритм действий. Ты должен советовать ему что делать, чётко следуя этой инструкции:
1. Действия при возникновении аварийной ситуации
Пункт 17 Приложения N 19 к Инструкции:
Машинист поезда или главный кондуктор , если он сопровождает поезд, обязаны немедленно сообщить о ЧС диспетчеру поездному или дежурному по ближайшей железнодорожной станции для принятия мер.
Сообщение должно включать обстоятельства аварии, наличие и расположение в составе поезда вагонов с ВМ (взрывчатые материалы) и вагонов с опасными грузами, а также передачу номеров аварийных карточек или содержание аварийных карточек.
В случае аварии, схода железнодорожного подвижного состава или пожара диспетчер поездной при необходимости должен дать указание энергодиспетчеру о снятии напряжения с контактной сети.
Машинист или главный кондуктор обязаны, исходя из обстановки, осуществлять возможные меры по ликвидации аварийной ситуации и её последствий, руководствуясь командами диспетчера поездного, требованиями должностной инструкции, аварийных карточек и указаниями специалистов, сопровождающих вагоны с ВМ и опасными грузами.
2. Действия дежурного по железнодорожной станции при ЧС
Пункт 18 Приложения N 19 к Инструкции:
Дежурный по железнодорожной станции, получив сообщение машиниста поезда об аварии, должен полностью передать его содержание диспетчеру поездному и действовать в соответствии с его указаниями.
3. Действия при возникновении пожара или создания пожароопасной ситуации
Пункт 20 Приложения N 19 к Инструкции:
В случае возникновения пожара или создания пожароопасной ситуации на объектах железнодорожной инфраструктуры или на подвижном составе, находящемся в радиусе до 100 м от вагонов с ВМ, работники железнодорожного транспорта должны принять меры по удалению вагонов с ВМ на безопасное расстояние, но не менее чем на 100 м от зоны пожара.
4. Ликвидация последствий аварийных ситуаций
Пункт 21 Приложения N 19 к Инструкции:
Диспетчер поездной обязан сообщить уполномоченному представителю владельца инфраструктуры о всех происшествиях с поездами и вагонами с ВМ и незамедлительно принять меры к быстрейшей ликвидации последствий аварийных ситуаций.
5. Обеспечение безопасности при авариях
Пункт 22 Приложения N 19 к Инструкции:
Действия по обеспечению безопасности и ликвидации последствий аварийных ситуаций с ВМ должны проводиться исходя из создавшейся обстановки согласно правилам безопасности и порядку ликвидации аварийных ситуаций с опасными грузами при их перевозке по железным дорогам и Правилами перевозок опасных грузов.
6. Дополнительные меры при ЧС
Пункт 17 Приложения N 12 к Инструкции:
В случае аварийной ситуации с ВМ в пределах железнодорожной станции дежурный по станции обязан сообщить о случившемся диспетчеру поездному и начальнику железнодорожной станции, установить возможность и условия дальнейшего пропуска поездов, производства маневровой работы, и при необходимости принять меры к прекращению движения поездов и маневров.

Надо написать только алгоритм действий диспетчера
Пример: user: человек выбежал на пути
model: Оценка текущей ситуации:
После подтверждения безопасности от машиниста и служб безопасности, оценить состояние пути и инфраструктуры на участке.
Убедиться, что препятствие (человек или иные объекты) полностью устранено.
Координация с соседними станциями:
Связаться с дежурными по ближайшим станциям для координации возобновления движения.
Уточнить, есть ли задержки у других поездов, ожидающих разрешения на движение.
Приоритеты в движении поездов:
Дать приоритет пассажирским поездам, особенно скоростным и международным, чтобы минимизировать их задержки.
Перенаправить грузовые поезда на резервные маршруты, если это необходимо для освобождения основных путей для пассажирских составов.
Пересчет интервалов движения:
Использовать диспетчерскую систему для пересчета временных интервалов между поездами.
Корректировать расписание, чтобы избежать скопления поездов на станциях или перегруженности путей.
Информирование заинтересованных сторон:
Сообщить начальнику станции и перевозчикам о возможных задержках.
Для пассажирских поездов организовать информирование пассажиров через вокзальные табло и объявления о причинах задержки.
Контроль исполнения корректировок:
Непрерывно мониторить ситуацию на участке и вносить корректировки в график, если возникают новые задержки.
Обеспечить четкую коммуникацию с машинистами для своевременного получения информации об их местоположении и состоянии.
Анализ последствий:
По завершении инцидента провести анализ влияния ЧС на график движения.
Определить необходимость дополнительных мер для предотвращения подобных ситуаций в будущем.
Документация изменений:
Задокументировать все принятые решения по корректировке графика, включая причины задержек, время их устранения и действия, предпринятые для нормализации движения.
'''

data = []
client = InferenceClient(
    provider="hyperbolic",
    api_key="<token>",
)
for i in range(4000):
    try:
        
        sit = choice(situations)
        messages = [
            {
                'role':'system',
                'text':system_prompt
            },
            {
                'role':'user',
                'text':sit
            }
        ]
        response = requests.post(
            url="https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": "Bearer <token>",
                "Content-Type": "application/json",
            },
            data=json.dumps({
                "model": "qwen/qwen2.5-vl-72b-instruct:free",
                "messages": messages
            })
        )
        response = response.json()['choices'][0]['message']['content']
        data.append({'situation': sit, 'reponse': response})
        print(len(data), end='\r')
    except Exception as e:
        if e == 'KeyboardInterrupt':
            break


with open('situations_and_solutions.json', 'w', encoding = 'utf-8') as f:
    json.dump(data, f, indent=4, ensure_ascii=False)
